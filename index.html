<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const apiKey = "e124a8f93b4a49a8b71f04b9e40503a8"; // Váš API klíč získaný od Bungie.net

      function authenticate() {
        const clientId = "44038"; // Váš klient ID získaný od Bungie.net
        const redirectUri = "https://mrkindesign.github.io/"; // Vaše přesměrovací URI registravané u Bungie.net

        // Adresa pro požádání o autorizaci uživatele k přístupu k účtu Destiny 2
        const authUrl = `https://www.bungie.net/en/OAuth/Authorize?client_id=${clientId}&response_type=code&redirect_uri=${redirectUri}`;

        // Otevře se okno s adresou pro autorizaci uživatele
        window.open(authUrl, "_blank");
      }

      // Funkce pro získání refresh tokenu z odpovědi API
      async function getRefreshToken(code) {
        const clientId = "44038"; // Váš klient ID získaný od Bungie.net
        const clientSecret = "iAm99vYYKsYWcF9-g04u0Vy3G-XJOv0lPfXS4P4Z2cU"; // Váš tajný klíč získaný od Bungie.net
        const redirectUri = "https://mrkindesign.github.io/"; // Vaše přesměrovací URI registravané u Bungie.net

        const tokenUrl = "https://www.bungie.net/platform/app/oauth/token/";
        const body = `grant_type=authorization_code&code=${code}&client_id=${clientId}&client_secret=${clientSecret}&redirect_uri=${redirectUri}`;

        const response = await axios.post(tokenUrl, body, {
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-API-Key": apiKey, // Přidání API klíče do hlavičky
          },
        });

        return response.data.refresh_token;
      }

      // Funkce pro získání nového access tokenu pomocí refresh tokenu
      async function getAccessToken(refreshToken) {
        const clientId = "44038"; // Váš klient ID získaný od Bungie.net
        const clientSecret = "iAm99vYYKsYWcF9-g04u0Vy3G-XJOv0lPfXS4P4Z2cU"; // Váš tajný klíč získaný od Bungie.net

        const tokenUrl = "https://www.bungie.net/platform/app/oauth/token/";
        const body = `grant_type=refresh_token&refresh_token=${refreshToken}&client_id=${clientId}&client_secret=${clientSecret}`;
        const response = await axios.post(tokenUrl, body, {
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-API-Key": apiKey, // Přidání API klíče do hlavičky
          },
        });

        return response.data.access_token;
      }

      // Funkce pro získání profilových informací o uživateli z API Destiny 2
      async function getProfileData(token) {
        const membershipType = 5; // Typ účtu (3 pro Xbox, 4 pro PlayStation, 5 pro Steam, 10 pro Stadia)
        const membershipId = "4611686018528150250"; // ID účtu Destiny 2 uživatele, získané z odpovědi API autorizace
        const components = "100"; // Kód komponentu pro získání profilových informací
        const profileUrl = `https://www.bungie.net/Platform/Destiny2/${membershipType}/Profile/${membershipId}/?components=${components}`;
        const response = await axios.get(profileUrl, {
          headers: {
            Authorization: `Bearer ${token}`,
            "X-API-Key": apiKey, // Přidání API klíče do hlavičky
          },
        });

        return response.data.Response;
      }

      // Funkce, která získá autorizační token po úspěšné autorizaci uživatele
      async function handleAuthCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");

        if (code) {
          const refreshToken = await getRefreshToken(code);
          const token = await getAccessToken(refreshToken);
          const profileData = await getProfileData(token);

          // Zde můžete provést další operace s profileData, například zobrazit informace o uživateli na stránce
          console.log(profileData);
        } else {
          console.error("Autorizační kód nebyl nalezen.");
        }
      }

      // Pokud uživatel vrátí z autorizační stránky s platným autorizačním kódem, zavolá se funkce handleAuthCallback()
      window.onload = handleAuthCallback;
    </script>
  </head>
  <body>
    <button id="authButton" onclick="authenticate()">
      Přihlásit se pomocí Destiny 2
    </button>
    sss
  </body>
</html>
